name: 🚀 CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: 🔍 Validate
    uses: ./.github/workflows/01-validate.yml

  test:
    name: 🧪 Test
    uses: ./.github/workflows/02-test.yml

  security:
    name: 🛡️ Security
    uses: ./.github/workflows/03-security.yml

  build:
    name: 📦 Build
    needs: [validate, test]
    uses: ./.github/workflows/04-build.yml

  deploy:
    name: 🚀 Deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [validate, test, security, build]
    uses: ./.github/workflows/05-deploy.yml
    secrets: inherit

  status:
    name: 📊 Pipeline Status
    runs-on: ubuntu-latest
    if: always()
    needs: [validate, test, security, build, deploy]
    
    steps:
      - name: 📊 Create Pipeline Summary
        run: |
          echo "## 🚀 CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| 🔍 Validate | ${{ needs.validate.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| 🧪 Test | ${{ needs.test.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| 🛡️ Security | ${{ needs.security.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| 📦 Build | ${{ needs.build.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| 🚀 Deploy | ${{ needs.deploy.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [[ "${{ needs.validate.result }}" == "success" && "${{ needs.test.result }}" == "success" && "${{ needs.security.result }}" == "success" && "${{ needs.build.result }}" == "success" ]]; then
            echo "✅ **Pipeline Status: SUCCESS**" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ github.ref }}" == "refs/heads/main" && "${{ needs.deploy.result }}" == "success" ]]; then
              echo "🚀 Successfully deployed to production!" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "❌ **Pipeline Status: FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the failed stages and fix the issues." >> $GITHUB_STEP_SUMMARY
          fi